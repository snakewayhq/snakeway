interface policy {
  /// HTTP header
  record header {
    name: string,
    value: string,
  }

  /// Request snapshot passed to devices (read-only)
  record request {
    /// Original request path as received
    original-path: string,

    /// Canonical path currently used for routing
    route-path: string,

    /// Headers at this stage of the pipeline
    headers: list<header>,
  }

  /// Response snapshot passed to devices (read-only)
  record response {
    status: u16,
    headers: list<header>,
  }

  /// Explicit request mutation intent
  record request-patch {
    /// Change the path used for routing (forces re-routing)
    set-route-path: option<string>,

    /// Override the path sent to the upstream (does not affect routing)
    set-upstream-path: option<string>,

    /// Headers to add or overwrite
    set-headers: list<header>,

    /// Headers to remove
    remove-headers: list<string>,
  }

  /// Explicit response mutation intent
  record response-patch {
    /// Override response status
    set-status: option<u16>,

    /// Headers to add or overwrite
    set-headers: list<header>,

    /// Headers to remove
    remove-headers: list<string>,
  }

  /// Device decision
  enum decision {
    continue,
    block,
  }

  /// Result of a request-phase hook
  record request-result {
    decision: decision,
    patch: option<request-patch>,
  }

  /// Result of a response-phase hook
  record response-result {
    decision: decision,
    patch: option<response-patch>,
  }

  /// Called immediately after request acceptance, before routing
  on-request: func(req: request) -> request-result;

  /// Called after routing but before proxying upstream
  before-proxy: func(req: request) -> request-result;

  /// Called after receiving the upstream response
  after-proxy: func(resp: response) -> response-result;

  /// Called just before sending the response to the client
  on-response: func(resp: response) -> response-result;
}
